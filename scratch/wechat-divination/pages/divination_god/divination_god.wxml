<view class="container">
  <view class="header">{{tossCount >= 6 ? '步骤完成' : '第 ' + (tossCount + 1) + ' 次步骤'}}</view>
  
  <view class="result-area">
    <view class="hexagram-visual">
      <!-- Loop 6 times for 6 lines. We use a fixed array [0,1,2,3,4,5] -->
      <block wx:for="{{[0, 1, 2, 3, 4, 5]}}" wx:key="*this">
          <!-- Check if we have data for this line index -->
          <view class="line-item {{lines[index] ? 'animate-line' : ''}}">
            <text class="line-position">{{lineLabels[index]}}</text>
            
            <!-- If line exists, show number and visual -->
            <block wx:if="{{lines[index]}}">
              <text class="line-number">{{lines[index]}}</text>
              <view class="line-content">
                  <!-- Solid Line (Yang Visual): 9 (Old Yang) and 7 (Young Yang) -->
                  <view wx:if="{{lines[index] == 9 || lines[index] == 7}}" class="yang-line {{ (lines[index] == 9) ? 'red' : '' }}"></view>
                  
                  <!-- Broken Line (Yin Visual): 6 (Old Yin) and 8 (Young Yin) -->
                  <view wx:if="{{lines[index] == 6 || lines[index] == 8}}" class="yin-line">
                      <view class="yin-segment {{ (lines[index] == 6) ? 'red' : '' }}"></view>
                      <view class="yin-segment {{ (lines[index] == 6) ? 'red' : '' }}"></view>
                  </view>
              </view>
            </block>
            
            <!-- If line doesn't exist yet, show empty placeholder -->
            <block wx:else>
              <text class="line-number placeholder"></text>
              <view class="line-content placeholder"></view>
            </block>
          </view>
      </block>
    </view>
  </view>

  <view class="input-area" wx:if="{{tossCount < 6}}">
    <view class="virtual-toss-section">
      <button class="virtual-btn" bindtap="virtualToss" disabled="{{isTossing}}">
        {{isTossing ? '硬币旋转中...' : '抛掷硬币'}}
      </button>
      <view class="toss-animation-container" wx:if="{{isTossing}}">
         <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="toss-coin coin-1 {{animationClass}}"></image>
         <image src="https://image.952712.xyz/file/1765097321758_fanmian.png" class="toss-coin coin-2 {{animationClass}}"></image>
         <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="toss-coin coin-3 {{animationClass}}"></image>
      </view>
    </view>

    <view class="input-label">手动记录结果</view>
    <view class="coin-selector">
      <!-- 3 Yang (Old Yang 9) -->
      <view class="coin-option {{selectedType === 9 ? 'selected' : ''}}" bindtap="selectResult" data-type="9">
        <view class="coins-visual">
          <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="coin-img yang"></image>
          <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="coin-img yang"></image>
          <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="coin-img yang"></image>
        </view>
        <text class="option-label">三个正面 (老阳 九)</text>
      </view>

      <!-- 3 Yin (Old Yin 6) -->
      <view class="coin-option {{selectedType === 6 ? 'selected' : ''}}" bindtap="selectResult" data-type="6">
        <view class="coins-visual">
          <image src="https://image.952712.xyz/file/1765097321758_fanmian.png" class="coin-img yin"></image>
          <image src="https://image.952712.xyz/file/1765097321758_fanmian.png" class="coin-img yin"></image>
          <image src="https://image.952712.xyz/file/1765097321758_fanmian.png" class="coin-img yin"></image>
        </view>
        <text class="option-label">三个反面 (老阴 六)</text>
      </view>

      <!-- 1 Yang 2 Yin (Young Yang 7) -->
      <view class="coin-option {{selectedType === 7 ? 'selected' : ''}}" bindtap="selectResult" data-type="7">
        <view class="coins-visual">
          <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="coin-img yang"></image>
          <image src="https://image.952712.xyz/file/1765097321758_fanmian.png" class="coin-img yin"></image>
          <image src="https://image.952712.xyz/file/1765097321758_fanmian.png" class="coin-img yin"></image>
        </view>
        <text class="option-label">一正二反 (少阳 七)</text>
      </view>

      <!-- 2 Yang 1 Yin (Young Yin 8) -->
      <view class="coin-option {{selectedType === 8 ? 'selected' : ''}}" bindtap="selectResult" data-type="8">
        <view class="coins-visual">
          <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="coin-img yang"></image>
          <image src="https://image.952712.xyz/file/1765097341280_zhengmian.png" class="coin-img yang"></image>
          <image src="https://image.952712.xyz/file/1765097321758_fanmian.png" class="coin-img yin"></image>
        </view>
        <text class="option-label">二正一反 (少阴 八)</text>
      </view>
    </view>

    <view class="action-area">
        <button class="confirm-btn" bindtap="confirmSelection" disabled="{{!selectedType}}">确定选择</button>
    </view>
    <view class="undo-container" wx:if="{{tossCount > 0}}">
        <button class="undo-btn" bindtap="undo">撤销上一步</button>
    </view>
  </view>

  <view class="completion-msg" wx:if="{{tossCount >= 6}}">
    <text>演练完成，正在生成解析...</text>
  </view>
</view>
